---

#Получение последнего билда CF (если cf_build не передан)
- name: "Получить последний билд CF (если не задан)"
  when: cf_build == ""
  block:
    - name: "Получить HTML со списком билдов CF"
      ansible.builtin.uri:
        url: "{{ product.cf_server.linux.base_uri }}/"
        method: GET
        return_content: true
        validate_certs: false
        status_code: 200
        url_username: "cyberprotect"
        url_password: "cyberprotect"
      register: cf_page
      ignore_errors: yes

    - name: "Найти последнюю версию CF"
      ansible.builtin.shell: |
        set -o pipefail
        # Универсальный поиск каталогов в HTML
        echo "{{ cf_page.content }}" | \
        grep -oE 'href="[^"]*/"' | \
        sed 's/href="//g; s/"//g; s/\/$//' | \
        grep -vE '^(\.\.|/builds/|/)$' | \
        sort -V | \
        tail -1
      args:
        executable: /bin/bash
      register: cf_version_dir
      changed_when: false
      when: cf_page.failed == false

    - name: "Получить список билдов для версии CF"
      ansible.builtin.uri:
        url: "{{ product.cf_server.linux.base_uri }}/{{ cf_version_dir.stdout | trim }}/"
        method: GET
        return_content: true
        validate_certs: false
        status_code: 200
        url_username: "cyberprotect"
        url_password: "cyberprotect"
      register: cf_builds_page
      when: cf_version_dir.stdout != "" and cf_version_dir.stdout | trim != ""
      ignore_errors: yes

    - name: "Извлечь последний билд CF"
      ansible.builtin.shell: |
        set -o pipefail
        # Универсальный поиск билдов (форматы: x.x.x, x.x.x.x, x.x.x-xxx, x.x.x.x-xxx)
        echo "{{ cf_builds_page.content }}" | \
        grep -oE 'href="[^"]*"' | \
        sed 's/href="//g; s/"//g' | \
        grep -E '^[0-9]+\.[0-9]+\.[0-9]+([\.-][0-9]+)?(x[0-9]+)?$' | \
        sort -V | \
        tail -1
      args:
        executable: /bin/bash
      register: cf_build_result
      changed_when: false
      when: cf_builds_page.failed == false and cf_version_dir.stdout != "" and cf_version_dir.stdout | trim != ""

    - name: "Сформировать полный путь CF"
      ansible.builtin.set_fact:
        cf_build: "{{ cf_version_dir.stdout | trim }}/{{ cf_build_result.stdout | trim }}"
      when: cf_version_dir.stdout != "" and cf_build_result.stdout != "" and cf_build_result.stdout | trim != ""

    - name: "Проверить, что билд CF найден"
      ansible.builtin.assert:
        that:
          - cf_build != ""
          - cf_build is defined
        fail_msg: "Не удалось определить билд для CF Server"
      when: cf_build == ""

#Получение последнего билда GW (если gw_build не передан)
- name: "Получить последний билд GW (если не задан)"
  when: gw_build == ""
  block:
    - name: "Получить HTML со списком билдов GW"
      ansible.builtin.uri:
        url: "{{ product.gw_server.linux.base_uri }}/"
        method: GET
        return_content: true
        validate_certs: false
        status_code: 200
        url_username: "cyberprotect"
        url_password: "cyberprotect"
      register: gw_page
      ignore_errors: yes

    - name: "Извлечь последний билд GW"
      ansible.builtin.shell: |
        set -o pipefail
        # Универсальный поиск номеров билдов в HTML
        echo "{{ gw_page.content }}" | \
        grep -oE 'href="[^"]*"' | \
        sed 's/href="//g; s/"//g' | \
        grep -E '^[0-9]+$' | \
        sort -n | \
        tail -1
      args:
        executable: /bin/bash
      register: gw_build_result
      changed_when: false
      when: gw_page.failed == false

    - name: "Установить номер сборки GW"
      ansible.builtin.set_fact:
        gw_build: "{{ gw_build_result.stdout | trim }}"

    - name: "Проверить, что номер сборки GW корректен"
      ansible.builtin.assert:
        that:
          - gw_build != ""
          - gw_build is defined
        fail_msg: "Не удалось извлечь номер сборки для GW"
      when: gw_build == ""
