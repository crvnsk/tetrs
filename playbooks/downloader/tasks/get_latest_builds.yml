---

#Получение последнего билда CF (если cf_build не передан)
- name: "Получить последний билд CF (если не задан)"
  when: cf_build == ""
  block:
    - name: "Получить HTML со списком билдов CF"
      ansible.builtin.uri:
        url: "{{ product.cf_server.linux.base_uri }}/"
        method: GET
        return_content: true
        validate_certs: false
        status_code: 200
        url_username: "cyberprotect"
        url_password: "cyberprotect"
      register: cf_page
      ignore_errors: yes

    - name: "Найти все каталоги CF"
      ansible.builtin.shell: |
        echo "{{ cf_page.content }}" | grep -oE '<a href="[^"]*">[^<]+</a>' | \
        grep 'href="[^"]*/"' | \
        sed 's/.*href="\([^"]*\)".*/\1/' | \
        sed 's/\/$//' | \
        grep -vE '^(\.\.|/|$)' | \
        sort -V | tail -1
      args:
        executable: /bin/bash
      register: cf_version_dir
      changed_when: false
      when: cf_page.failed == false

    - name: "Показать найденную версию CF"
      ansible.builtin.debug:
        msg: "Найдена версия CF: {{ cf_version_dir.stdout }}"

    - name: "Получить список билдов для версии CF"
      ansible.builtin.uri:
        url: "{{ product.cf_server.linux.base_uri }}/{{ cf_version_dir.stdout }}/"
        method: GET
        return_content: true
        validate_certs: false
        status_code: 200
        url_username: "cyberprotect"
        url_password: "cyberprotect"
      register: cf_builds_page
      when: cf_version_dir.stdout != ""
      ignore_errors: yes

    - name: "Найти последний билд CF"
      ansible.builtin.shell: |
        echo "{{ cf_builds_page.content }}" | grep -oE '<a href="[^"]*">[^<]+</a>' | \
        grep -vE '>(\.\.|/|metadata|Parent Directory)</a>' | \
        sed 's/.*href="\([^"]*\)".*/\1/' | \
        grep -E '^[0-9]' | \
        sort -V | tail -1
      args:
        executable: /bin/bash
      register: cf_build_result
      changed_when: false
      when: cf_builds_page.failed == false and cf_version_dir.stdout != ""

    - name: "Сформировать полный путь CF"
      ansible.builtin.set_fact:
        cf_build: "{{ cf_version_dir.stdout }}/{{ cf_build_result.stdout }}"
      when: cf_version_dir.stdout != "" and cf_build_result.stdout != ""

    - name: "Проверить, что билд CF найден"
      ansible.builtin.assert:
        that:
          - cf_build != ""
          - cf_build is defined
        fail_msg: "Не удалось определить билд для CF Server"
      when: cf_build == ""

#Получение последнего билда GW (если gw_build не передан)
- name: "Получить последний билд GW (если не задан)"
  when: gw_build == ""
  block:
    - name: "Получить HTML со списком билдов GW"
      ansible.builtin.uri:
        url: "{{ product.gw_server.linux.base_uri }}/"
        method: GET
        return_content: true
        validate_certs: false
        status_code: 200
        url_username: "cyberprotect"
        url_password: "cyberprotect"
      register: gw_page
      ignore_errors: yes

    - name: "Найти последний билд GW"
      ansible.builtin.shell: |
        echo "{{ gw_page.content }}" | grep -oE '<a href="[^"]*">[^<]+</a>' | \
        grep 'href="[^"]*/"' | \
        sed 's/.*href="\([^"]*\)".*/\1/' | \
        sed 's/\/$//' | \
        grep -E '^[0-9]+$' | \
        sort -n | tail -1
      args:
        executable: /bin/bash
      register: gw_build_result
      changed_when: false
      when: gw_page.failed == false

    - name: "Установить номер сборки GW"
      ansible.builtin.set_fact:
        gw_build: "{{ gw_build_result.stdout }}"

    - name: "Проверить, что номер сборки GW корректен"
      ansible.builtin.assert:
        that:
          - gw_build != ""
          - gw_build is defined
        fail_msg: "Не удалось извлечь номер сборки для GW"
      when: gw_build == ""
